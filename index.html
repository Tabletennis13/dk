<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>–†–µ–π—Ç–∏–Ω–≥ —Ç–µ–Ω–Ω–∏—Å–∞</title>
    <!-- –°—Ç–∏–ª–∏ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å -->
    <style>
        /* –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ (–ø—Ä–∏–º–µ—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏) */
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#333;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:8px;-webkit-text-size-adjust:100%;overflow-x:hidden}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.1);overflow:hidden}
        header{background:linear-gradient(135deg,#4CAF50 0%,#2E7D32 100%);color:white;padding:18px 12px;text-align:center}
        header h1{font-size:1.6em;margin-bottom:6px;word-break:break-word;line-height:1.3}
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ ... */
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <div class="container" id="playerProfileContainer" style="display:none"></div>
    <div class="container" id="tournamentPageContainer" style="display:none"></div>
    <div class="container" id="appContainer">
        <!-- –®–∞–ø–∫–∞ –∏ –≤–∫–ª–∞–¥–∫–∏ -->
        <header>
            <h1>üèì –†–µ–π—Ç–∏–Ω–≥ –õ–õ–ù–¢</h1>
            <div class="header-subtitle">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –õ–∏–≥–∏ –õ—é–±–∏—Ç–µ–ª–µ–π –ù–∞—Å—Ç–æ–ª—å–Ω–æ–≥–æ –¢–µ–Ω–Ω–∏—Å–∞</div>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('rating')">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
            <button class="tab-btn" onclick="openTab('matches')">üéÆ –ú–∞—Ç—á–∏</button>
            <button class="tab-btn" onclick="openTab('players')">üë• –ò–≥—Ä–æ–∫–∏</button>
            <button class="tab-btn" onclick="openTab('tournaments')">üèÖ –¢—É—Ä–Ω–∏—Ä—ã</button>
            <button class="tab-btn" onclick="openTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="tab-btn" onclick="openTab('penalties')">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</button>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞) -->
        <div class="tab-content active" id="rating">
            <h2>üèÜ –¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2>
            <div class="table-container">
                <table class="compact-table">
                    <thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–≥—Ä–æ–∫</th><th>–û—á–∫–∏</th><th>–ú–∞—Ç—á–∏</th><th>–ü–æ–±–µ–¥</th><th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∏–≥—Ä–∞</th><th>–ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="ratingBody"></tbody>
                </table>
            </div>
            <div class="achievements-container" id="achievementsContainer">
                <!-- –ë–ª–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
            </div>
        </div>
        
        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ —Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π -->
        <div class="tab-content" id="matches">
            <h2>üéÆ –ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π</h2>
            <div id="matchesContainer"></div>
            <!-- –ê–¥–º–∏–Ω-–∫–æ–Ω—Ç—Ä–æ–ª—ã -->
        </div>
        
        <div class="tab-content" id="players">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞–º–∏</h2>
            <!-- –ê–¥–º–∏–Ω-–∫–æ–Ω—Ç—Ä–æ–ª—ã -->
            <div class="table-container">
                <table><thead><tr><th>–ê–≤–∞—Ç–∞—Ä</th><th>–ò–º—è</th><th>–†–µ–π—Ç–∏–Ω–≥</th><th>–ú–∞—Ç—á–∏</th><th>–ü–æ–±–µ–¥</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                <tbody id="playersBody"></tbody></table>
            </div>
        </div>
        
        <div class="tab-content" id="tournaments">
            <h2>üèÖ –¢—É—Ä–Ω–∏—Ä—ã</h2>
            <!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ -->
        </div>
        
        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <div class="tab-content" id="stats">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        </div>
        
        <div class="tab-content" id="penalties">
            <h2>‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤ –∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
            <!-- –®—Ç—Ä–∞—Ñ—ã -->
        </div>
        
        <!-- –ü–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="bottom-panels">
            <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, Supabase –ø–∞–Ω–µ–ª—å –∏ –≤—Ö–æ–¥ -->
        </div>
    </div>

    <script>
    // ============================================
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ============================================
    const CONFIG = {
        SUPABASE_URL: 'https://bqycjfcjtdawyrysgrbw.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxeWNqZmNqdGRhd3lyeXNncmJ3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjYwMTk3MCwiZXhwIjoyMDgyMTc3OTcwfQ.lHA_79fw8PSj9ZHMExBpSEIpkonkCYOni7HniGGqadY',
        ADMIN_PASSWORD: "admin123",
        ACHIEVEMENT_LEVELS: [
            { threshold: 1100, name: "–ù–∞—á–∏–Ω–∞—é—â–∏–π —á–µ–º–ø–∏–æ–Ω", icon: "ü•â", color: "#CD7F32", bonus: 16 },
            { threshold: 1300, name: "–û–ø—ã—Ç–Ω—ã–π –±–æ–µ—Ü", icon: "ü•à", color: "#C0C0C0", bonus: 20 },
            { threshold: 1500, name: "–ú–∞—Å—Ç–µ—Ä —Å—Ç–æ–ª–∞", icon: "ü•á", color: "#FF9800", bonus: 30 },
            { threshold: 2000, name: "–õ–µ–≥–µ–Ω–¥–∞ –ª–∏–≥–∏", icon: "üëë", color: "#FFD700", bonus: 50 }
        ]
    };

    let players = {}, matches = [], penaltyLog = [], tournaments = [], tournamentMatches = [], tournamentPhotos = [];
    let supabaseClient = null, isAdmin = false, isSupabaseInitialized = false;

    // ============================================
    // –û–°–ù–û–í–ù–´–ï –ö–õ–ê–°–°–´ –ò –£–¢–ò–õ–ò–¢–´
    // ============================================
    class AppUtils {
        static showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;color:white;
                font-weight:bold;z-index:1000;animation:slideIn 0.3s ease,fadeOut 0.3s ease 2.7s;
                box-shadow:0 4px 12px rgba(0,0,0,0.15);max-width:calc(100vw - 40px);font-size:14px;
                background:${type==='success'?'#4CAF50':type==='error'?'#f44336':type==='warning'?'#ff9800':'#2196F3'};
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.parentNode?.removeChild(notification), 3000);
        }

        static getPluralForm(number) {
            if (number % 10 === 1 && number % 100 !== 11) return '';
            if (number % 10 >= 2 && number % 10 <= 4 && (number % 100 < 10 || number % 100 >= 20)) return '–∞';
            return '–µ–π';
        }

        static getAchievementEmojis(rating) {
            return CONFIG.ACHIEVEMENT_LEVELS
                .filter(l => rating >= l.threshold)
                .map(l => `<span class="achievement-emoji">${l.icon}</span>`)
                .join('');
        }

        static formatDate(date) {
            return date ? date.toLocaleDateString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
        }
    }

    // ============================================
    // –°–£–ü–ê–ë–ï–ô–° –ú–ï–ù–ï–î–ñ–ï–†
    // ============================================
    class SupabaseManager {
        static async init() {
            if (!window.supabase) await this.loadLibrary();
            supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
            isSupabaseInitialized = true;
            await this.loadAllData();
            setInterval(() => this.loadAllData(), 30000);
            return supabaseClient;
        }

        static async loadLibrary() {
            return new Promise((resolve, reject) => {
                if (window.supabase) return resolve();
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.async = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        static async loadAllData() {
            if (!supabaseClient) return;
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
                const { data: playersData } = await supabaseClient.from('players').select('*').order('rating', { ascending: false });
                if (playersData) players = playersData.reduce((acc, p) => ({...acc, [p.name]: {
                    rating: p.rating || 1000, matches: p.matches || 0, wins: p.wins || 0,
                    lastGame: p.last_game ? new Date(p.last_game) : null, joinDate: p.join_date ? new Date(p.join_date) : new Date(),
                    penalties: p.penalties || 0, avatar: p.avatar || `https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 70) + 1}`,
                    achievement_bonuses: p.achievement_bonuses || {}
                }}), {});

                // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π
                const { data: matchesData } = await supabaseClient.from('matches').select('*').order('date', { ascending: false });
                if (matchesData) matches = matchesData.map(m => ({
                    id: m.id, date: new Date(m.date), player1: m.player1, player2: m.player2,
                    winner: m.winner, change1: m.change1 || 0, change2: m.change2 || 0, score: m.score || ''
                }));

                // –ó–∞–≥—Ä—É–∑–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤
                const { data: penaltiesData } = await supabaseClient.from('penalties').select('*').order('date', { ascending: false });
                if (penaltiesData) penaltyLog = penaltiesData.map(p => ({
                    id: p.id, date: new Date(p.date), player: p.player, amount: p.amount || 0,
                    daysInactive: p.days_inactive || 0, manual: p.manual || false
                }));

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤
                await this.loadTournaments();
                AppUtils.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                updateAllDisplays();
                if (isAdmin) setTimeout(applyAchievementBonuses, 1000);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                AppUtils.showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        static async loadTournaments() {
            const { data: tData } = await supabaseClient.from('tournaments').select('*').order('created_at', { ascending: false });
            const { data: tmData } = await supabaseClient.from('tournament_matches').select('*');
            const { data: tpData } = await supabaseClient.from('tournament_photos').select('*');
            tournaments = tData || []; tournamentMatches = tmData || []; tournamentPhotos = tpData || [];
        }

        static async savePlayer(name, data) {
            if (!supabaseClient) return;
            await supabaseClient.from('players').upsert({
                name, rating: data.rating, matches: data.matches, wins: data.wins,
                last_game: data.lastGame, join_date: data.joinDate, penalties: data.penalties,
                avatar: data.avatar, achievement_bonuses: data.achievement_bonuses || {}
            }, { onConflict: 'name' });
        }

        static async saveMatch(match) {
            if (!supabaseClient) return;
            await supabaseClient.from('matches').insert({
                date: match.date.toISOString(), player1: match.player1, player2: match.player2,
                winner: match.winner, change1: match.change1, change2: match.change2, score: match.score
            });
        }

        static async deleteMatch(id) {
            if (!supabaseClient) return;
            await supabaseClient.from('matches').delete().eq('id', id);
        }
    }

    // ============================================
    // –ò–ì–†–û–ö–ò –ò –ú–ê–¢–ß–ò
    // ============================================
    class MatchManager {
        static async addMatch(date, p1, p2, winner, score) {
            if (!isAdmin) return AppUtils.showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–Ω–æ—Å–∏—Ç—å –º–∞—Ç—á–∏!', 'error');
            if (!p1 || !p2 || p1 === p2 || !date) return AppUtils.showNotification('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!', 'error');

            const matchDate = new Date(date);
            matchDate.setHours(new Date().getHours(), new Date().getMinutes(), new Date().getSeconds());
            const realWinner = winner === 'player1' ? p1 : winner === 'player2' ? p2 : 'draw';
            
            const rating1 = players[p1].rating, rating2 = players[p2].rating;
            const ratingDiff = Math.abs(rating1 - rating2);
            const strongPlayer = rating1 > rating2 ? p1 : p2;
            const weakPlayer = rating1 > rating2 ? p2 : p1;
            const isUpset = realWinner === weakPlayer;
            
            let change1, change2;
            if (realWinner === p1) {
                players[p1].wins++;
                change1 = (isUpset && ratingDiff >= 200 && p1 === weakPlayer) ? 32 : 16;
                change2 = -change1;
            } else if (realWinner === p2) {
                players[p2].wins++;
                change2 = (isUpset && ratingDiff >= 200 && p2 === weakPlayer) ? 32 : 16;
                change1 = -change2;
            } else {
                change1 = change2 = 0;
            }

            players[p1].rating += change1; players[p2].rating += change2;
            players[p1].matches++; players[p2].matches++;
            players[p1].lastGame = players[p2].lastGame = matchDate;

            const newMatch = { id: Date.now().toString(), date: matchDate, player1: p1, player2: p2, 
                winner: realWinner, change1, change2, score };
            
            matches.unshift(newMatch);
            await SupabaseManager.saveMatch(newMatch);
            await SupabaseManager.savePlayer(p1, players[p1]);
            await SupabaseManager.savePlayer(p2, players[p2]);
            
            updateAllDisplays();
            AppUtils.showNotification(`‚úÖ –ú–∞—Ç—á –¥–æ–±–∞–≤–ª–µ–Ω! ${p1}: ${change1>0?'+':''}${change1}, ${p2}: ${change2>0?'+':''}${change2}`, 'success');
            setTimeout(applyAchievementBonuses, 500);
        }

        static async deleteMatch(id) {
            if (!isAdmin) return AppUtils.showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –º–∞—Ç—á–∏!', 'error');
            const match = matches.find(m => m.id === id);
            if (!match) return;

            players[match.player1].rating -= match.change1;
            players[match.player1].matches--;
            if (match.winner === match.player1) players[match.player1].wins--;
            
            players[match.player2].rating -= match.change2;
            players[match.player2].matches--;
            if (match.winner === match.player2) players[match.player2].wins--;

            matches = matches.filter(m => m.id !== id);
            await SupabaseManager.deleteMatch(id);
            await SupabaseManager.savePlayer(match.player1, players[match.player1]);
            await SupabaseManager.savePlayer(match.player2, players[match.player2]);
            
            updateAllDisplays();
            AppUtils.showNotification("‚úÖ –ú–∞—Ç—á —É–¥–∞–ª–µ–Ω!", 'success');
        }
    }

    // ============================================
    // –°–ò–°–¢–ï–ú–ê –î–û–°–¢–ò–ñ–ï–ù–ò–ô
    // ============================================
    async function applyAchievementBonuses() {
        if (!isAdmin) return;
        let anyBonusesApplied = false;
        
        for (const [name, data] of Object.entries(players)) {
            if (!data.achievement_bonuses) data.achievement_bonuses = {};
            
            for (const level of CONFIG.ACHIEVEMENT_LEVELS) {
                if (data.rating >= level.threshold && !data.achievement_bonuses[level.threshold]) {
                    data.rating += level.bonus;
                    data.achievement_bonuses[level.threshold] = true;
                    anyBonusesApplied = true;
                    
                    await SupabaseManager.savePlayer(name, data);
                    AppUtils.showNotification(`üéÅ ${name} –ø–æ–ª—É—á–∏–ª +${level.bonus} –æ—á–∫–æ–≤ –∑–∞ —É—Ä–æ–≤–µ–Ω—å ${level.name}!`, 'success');
                }
            }
        }
        
        if (anyBonusesApplied) updateAllDisplays();
    }

    // ============================================
    // –¢–£–†–ù–ò–†–´ (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
    // ============================================
    class TournamentManager {
        static async generateTournament(name, type, selectedPlayers) {
            if (!isAdmin) return AppUtils.showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä—ã!', 'error');
            
            const newTournament = {
                id: Date.now().toString(), name, type, players: selectedPlayers,
                status: 'active', created_at: new Date().toISOString(), winner: null, is_pairs: type.includes('pairs')
            };
            
            await supabaseClient.from('tournaments').insert(newTournament);
            tournaments.unshift(newTournament);
            updateTournamentsDisplay();
            AppUtils.showNotification(`‚úÖ –¢—É—Ä–Ω–∏—Ä "${name}" —Å–æ–∑–¥–∞–Ω!`, 'success');
        }

        static async enterMatchResult(tournamentId, playerName, matchId = null, isPairs = false) {
            if (!isAdmin) return AppUtils.showNotification('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–Ω–æ—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!', 'error');
            // –õ–æ–≥–∏–∫–∞ –≤–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞
        }
    }

    // ============================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
    // ============================================
    function updateAllDisplays() {
        updateRatingTable();
        updateMatchesTable();
        updatePlayersTable();
        updatePenaltiesHistory();
        updatePlayerSelects();
        updateAchievementsDisplay();
        updateTournamentsDisplay();
    }

    function updateRatingTable() {
        const tbody = document.getElementById('ratingBody');
        if (!tbody) return;
        
        const sortedPlayers = Object.entries(players).sort(([,a], [,b]) => b.rating - a.rating);
        tbody.innerHTML = sortedPlayers.map(([name, data], index) => {
            const daysInactive = data.lastGame ? Math.floor((new Date() - data.lastGame) / (1000 * 60 * 60 * 24)) : 
                Math.floor((new Date() - data.joinDate) / (1000 * 60 * 60 * 24));
            
            const emojis = AppUtils.getAchievementEmojis(data.rating);
            const nameClass = name.length > 20 ? 'long-name' : '';
            
            if (isAdmin) {
                return `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><div class="player-cell-with-emojis" onclick="showPlayerProfile('${name}')" style="cursor:pointer;">
                            <img src="${data.avatar}" class="avatar" onerror="this.src='https://i.pravatar.cc/150?img=3'">
                            <span class="${nameClass}">${name}</span><div class="player-emojis">${emojis}</div>
                        </div></td>
                        <td><input type="number" class="rating-input" value="${data.rating}" data-player="${name}" min="0" max="3000"></td>
                        <td>${data.matches}</td><td>${data.wins} (${data.matches ? Math.round(data.wins/data.matches*100) : 0}%)</td>
                        <td>${AppUtils.formatDate(data.lastGame)}</td><td>${daysInactive} –¥–Ω–µ–π</td>
                        <td><button class="penalty-btn action-btn" onclick="applyManualPenalty('${name}')" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à—Ç—Ä–∞—Ñ -60">-60</button></td>
                    </tr>`;
            } else {
                return `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><div class="player-cell-with-emojis" onclick="showPlayerProfile('${name}')" style="cursor:pointer;">
                            <img src="${data.avatar}" class="avatar" onerror="this.src='https://i.pravatar.cc/150?img=3'">
                            <span class="${nameClass}">${name}</span><div class="player-emojis">${emojis}</div>
                        </div></td>
                        <td><span class="rating-badge">${data.rating}</span></td><td>${data.matches}</td>
                        <td>${data.wins} (${data.matches ? Math.round(data.wins/data.matches*100) : 0}%)</td>
                        <td>${AppUtils.formatDate(data.lastGame)}</td><td>${daysInactive} –¥–Ω–µ–π</td>
                        <td>${daysInactive >= 14 ? '‚ö†Ô∏è' : '‚úÖ'}</td>
                    </tr>`;
            }
        }).join('');
        
        updateAchievementsDisplay();
    }

    function updateMatchesTable() {
        const container = document.getElementById('matchesContainer');
        if (!container) return;
        
        if (matches.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:25px;background:#f8f9fa;border-radius:10px;margin:15px 0;">
                <h3 style="font-size:16px;margin-bottom:10px;">üéæ –ú–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</h3><p style="font-size:14px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –º–∞—Ç—á</p></div>`;
            return;
        }
        
        const matchesByDay = {};
        matches.forEach(m => {
            const dateKey = m.date.toDateString();
            if (!matchesByDay[dateKey]) matchesByDay[dateKey] = [];
            matchesByDay[dateKey].push(m);
        });
        
        const sortedDays = Object.keys(matchesByDay).sort((a, b) => new Date(b) - new Date(a));
        container.innerHTML = sortedDays.map((dayKey, dayIndex) => {
            const dayMatches = matchesByDay[dayKey];
            const dayDate = new Date(dayKey);
            const today = new Date(), yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            
            let displayDate = dayDate.toDateString() === today.toDateString() ? '–°–µ–≥–æ–¥–Ω—è' : 
                dayDate.toDateString() === yesterday.toDateString() ? '–í—á–µ—Ä–∞' : 
                dayDate.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            displayDate = displayDate.charAt(0).toUpperCase() + displayDate.slice(1);
            
            const dayId = 'matchDay_' + dayKey.replace(/\s+/g, '_');
            const collapsed = dayIndex >= 2 ? 'collapsed' : '';
            
            return `
                <div class="match-day-header ${collapsed}" data-day-id="${dayId}" onclick="toggleDayGroup('${dayId}')">
                    <div class="day-info"><div class="toggle-icon">‚ñº</div><div class="day-date">${displayDate}</div></div>
                    <div class="match-count">${dayMatches.length} –º–∞—Ç—á${AppUtils.getPluralForm(dayMatches.length)}</div>
                </div>
                <div class="match-day-group ${collapsed}" id="${dayId}">
                    <div class="table-container">
                        <table><thead><tr><th>–í—Ä–µ–º—è</th><th>–ò–≥—Ä–æ–∫ 1</th><th>–ò–≥—Ä–æ–∫ 2</th><th>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</th><th>–°—á–µ—Ç</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                        <tbody>${dayMatches.map(m => `
                            <tr>
                                <td>${m.date.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'})}</td>
                                <td><div class="player-cell" onclick="showPlayerProfile('${m.player1}')" style="cursor:pointer;">
                                    <img src="${players[m.player1]?.avatar||'https://i.pravatar.cc/150?img=3'}" class="avatar" style="width:32px;height:32px;">
                                    <span>${m.player1}</span></div></td>
                                <td><div class="player-cell" onclick="showPlayerProfile('${m.player2}')" style="cursor:pointer;">
                                    <img src="${players[m.player2]?.avatar||'https://i.pravatar.cc/150?img=3'}" class="avatar" style="width:32px;height:32px;">
                                    <span>${m.player2}</span></div></td>
                                <td><strong>${m.winner === 'draw' ? '–ù–∏—á—å—è' : (m.winner || '-')}</strong></td>
                                <td>${m.score || '-'}</td>
                                <td><span style="color:${m.change1>0?'#4CAF50':'#f44336'}">${m.change1>0?'+':''}${m.change1}</span> / 
                                    <span style="color:${m.change2>0?'#4CAF50':'#f44336'}">${m.change2>0?'+':''}${m.change2}</span></td>
                                <td>${isAdmin?`<button class="delete-btn action-btn" onclick="MatchManager.deleteMatch('${m.id}')" title="–£–¥–∞–ª–∏—Ç—å –º–∞—Ç—á">üóëÔ∏è</button>`:'-'}</td>
                            </tr>`).join('')}
                        </tbody></table>
                    </div>
                </div>`;
        }).join('');
    }

    // ============================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
    // ============================================
    function toggleDayGroup(dayId) {
        const target = document.getElementById(dayId);
        const header = document.querySelector(`[data-day-id="${dayId}"]`);
        if (target && header) {
            target.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }
    }

    function openTab(tabName) {
        document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName)?.classList.add('active');
        document.querySelector(`.tab-btn[onclick*="${tabName}"]`)?.classList.add('active');
        
        if (tabName === 'stats') setTimeout(updateYearProgressChart, 100);
        if (tabName === 'tournaments') setTimeout(() => { updateTournamentsDisplay(); updateTournamentPlayersList(); }, 100);
    }

    function showPlayerProfile(playerName) {
        if (!players[playerName]) return AppUtils.showNotification('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('playerProfileContainer').style.display = 'block';
        document.getElementById('playerProfileName').textContent = playerName;
        document.getElementById('playerProfileAvatar').src = players[playerName].avatar;
        document.getElementById('playerProfileRating').textContent = `–†–µ–π—Ç–∏–Ω–≥: ${players[playerName].rating} –æ—á–∫–æ–≤`;
        document.getElementById('playerProfileEmojis').innerHTML = AppUtils.getAchievementEmojis(players[playerName].rating);
        updatePlayerStats(playerName);
        updatePlayerAchievements(playerName);
        renderPlayerFormChart(playerName);
        window.scrollTo(0, 0);
    }

    function returnToMain() {
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('playerProfileContainer').style.display = 'none';
        document.getElementById('tournamentPageContainer').style.display = 'none';
        window.scrollTo(0, 0);
        return false;
    }

    // ============================================
    // –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò
    // ============================================
    function loginAdmin() {
        const password = document.getElementById('adminPassword').value;
        if (password === CONFIG.ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('appContainer').classList.add('admin-active');
            document.getElementById('loginPanel').style.display = 'none';
            ['ratingAdminControls','matchesAdminControls','penaltiesAdminControls','playersAdminControls'].forEach(id => 
                document.getElementById(id).style.display = 'block');
            localStorage.setItem('tennisAdmin', 'true');
            updateAllDisplays();
            setTimeout(applyAchievementBonuses, 1000);
            AppUtils.showNotification('‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!', 'success');
        } else {
            AppUtils.showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
        }
    }

    function logoutAdmin() {
        isAdmin = false;
        document.getElementById('appContainer').classList.remove('admin-active');
        document.getElementById('loginPanel').style.display = 'block';
        ['ratingAdminControls','matchesAdminControls','penaltiesAdminControls','playersAdminControls'].forEach(id => 
            document.getElementById(id).style.display = 'none');
        localStorage.removeItem('tennisAdmin');
        updateAllDisplays();
        AppUtils.showNotification('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'info');
    }

    function checkAutoLogin() {
        if (localStorage.getItem('tennisAdmin') === 'true') {
            isAdmin = true;
            document.getElementById('appContainer').classList.add('admin-active');
            document.getElementById('loginPanel').style.display = 'none';
            ['ratingAdminControls','matchesAdminControls','penaltiesAdminControls','playersAdminControls'].forEach(id => 
                document.getElementById(id).style.display = 'block');
        }
    }

    // ============================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ============================================
    async function init() {
        checkAutoLogin();
        setMatchDateToToday();
        await SupabaseManager.init();
        updatePlayerSelects();
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
    }

    function setMatchDateToToday() {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('matchDate');
        if (dateInput) {
            dateInput.value = today;
            dateInput.min = '2020-01-01';
            dateInput.max = today;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            @keyframes slideIn {from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1}}
            @keyframes fadeOut {from{opacity:1} to{opacity:0}}
        </style>
    `);
    </script>
</body>
</html>
